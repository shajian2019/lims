<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>信件登记</title>
	<link href="${ctx}/plugins/layui/css/layui.css" rel="stylesheet" />
	<link rel="stylesheet" href="${ctx}/plugins/font-awesome/css/font-awesome.min.css" media="all" />
	<style type="text/css">
		.layui-form-item{margin-bottom: 10px;}
    	.main{width:660px;margin: 1% auto 0;}
		.img-up-box,#spr{max-width: 500px;height: auto;display:flex;align-items: flex-end;flex-wrap: wrap;}
		.img-up-box .img-box{position: relative;display: inline-block;width: 80px;height:80px;border: 1px solid #e6e6e6;margin-right: 8px;margin-top: 8px;}
		.img-up-box .img-box .img-close{position: absolute;top: -7px;right: -7px;font-size: 12px;color: #fff;border-radius: 20px;width: 16px;height: 16px;background-color: #000;text-align: center;line-height: 16px;}
		.img-up-box .img-box>img{width: 100%;height:100%;}
		#img_up,#spr_add{width: 80px;height:80px;border: 1px solid #e6e6e6;text-align: center;line-height: 80px;font-size: 28px;color: #e6e6e6;background-color: #fff;}
		#spr{align-items:flex-start;}
		#spr_add{width: 70px;height: 70px;line-height: 70px;border-radius: 1000px;}
		.spr-select{text-align: center;position: relative;margin-right: 15px;display: inline-block;}
		.spr-box{color: #fff;text-align: center;background-color: cornflowerblue;border-radius: 1000px;font-size: 12px;width: 70px;height: 70px;display: flex;flex-direction: column;justify-content: center;}
		.spr-close{cursor: pointer;position: absolute;top: 0;right: -7px;font-size: 12px;color: #fff;border-radius: 20px;width: 16px;background-color: #000;text-align: center;line-height: 16px;}
		#layer-photos{display:flex;align-items: center;max-width: 500px;flex-wrap: wrap;}
		#layer-photos img{width: 80px; height: 80px;display: block;margin-right: 5px;margin-bottom: 5px;}
		h2{text-align: center;margin-top: 20px;margin-bottom: 20px}
	</style>
</head>

<body>
	<h2>环保局信件登记单</h2>
	${(form!'开发中')}
</body>
<script src="${ctx}/plugins/layui/layui.all.js"></script>
<script src="${ctx}/js/common/download.js"></script>
<script type="text/javascript">
	var $ = layui.jquery,laydate = layui.laydate,form=layui.form,upload = layui.upload,laytpl=layui.laytpl,index=null,formFilter="mailregistration";
	var formkey = "${formkey!''}";
	var sprs = [];
	var usersprs = [];
	if(formkey == 'mailregistration_startevent1.html'){
		
		form.val(formFilter, {
			  "u_id": "${(USER.u_id)!''}",
			  "sqr": "${(mailregistration.sqr)!''}",
			  "sqrq": "${.now?string('yyyy-MM-dd HH:mm:ss')}", 
		})
		
		$.ajax({
            type: "get",
            data: {"u_id":"${USER.u_id}"},
            url: "${ctx}/grgzt/fqlc/getOrgs",
            success: function (data) {
				$.each(data, function (index, item) {
                    $('#bmmc').append(new Option(item.name, item.name));// 下拉菜单里添加元素
                });
				form.render("select");
            },
            error: function (data) {
                layer.msg("服务端异常");
            }
        });
		
		
		laydate.render({
		   elem: '#djsj'
		   ,type: 'date'
		});
		
		getSprs()
		
  	//申请
	form.on('submit(sq)', function(data){
		if(sprs.length > 0){
			 data.field.sprs = sprs.join(",")
			 data.field.usersprs = usersprs.join(",")
			 data.field.id = "${USER.u_id}mailregistration${formkey!''}";
			 data.field.bk = "${(mailregistration.bk)!''}";
			 data.field.sqrq = "${.now?string('yyyy-MM-dd HH:mm:ss')}";
			 $.ajax({
		            type: "post",
		            data: data.field,
		            url: "${ctx}/grgzt/fqlc/start/mailregistration",
		            beforeSend: function () {
		                index = layer.load(1);
		            },
		            success: function (data) {
		            	layer.close(index);
		            	if(data.code >0){
		            		layer.confirm("申请成功,流程单号："+data.bk+",下一流程节点："+data.msg, {
		            			  closeBtn:0,
		            			  btn: ['确定'] //按钮
		            			}, function(){
		            			 parent.window.closeTab("mailregistration");
	            			});
		            	}else{
		            		layer.msg("申请失败");
		            	}
		            },
		            error: function (data) {
		            	layer.close(index);
		                layer.msg("服务端异常");
		            }
		      });
		 } else {
			 layer.msg("请选择审批人", {offset: ['50%'], time: 2000});
		 }
		 return false;
	 });
	
	} else if (formkey == 'mailregistration_usertask1.html'){
		getSprs();
		
		laydate.render({
		   elem: '#dfsj'
		   ,type: 'date'
		   ,value: new Date()
		});
		
		//审批
		form.on('submit(sp)', function(data){
			if(sprs.length > 0){
				data.field.sprs = sprs.join(",")
				data.field.usersprs = usersprs.join(",")
				data.field.id = "${USER.u_id}mailregistration${formkey!''}";
				data.field.bk = "${bk!''}";
				data.field.agree = "true";
				$.ajax({
		            type: "post",
		            data: data.field,
		            url: "${ctx}/grgzt/dbsx/complete/${taskId!''}",
		            beforeSend: function () {
		                index = layer.load(1);
		            },
		            success: function (data) {
		            	layer.close(index);
		            	if(data.code >0){
		            		index = layer.confirm("审批成功,下一流程节点："+data.msg, {
		            			  closeBtn:0,
		            			  btn: ['确定'] //按钮
		            			}, function(){
		            			index = parent.layer.getFrameIndex(window.name);
						    	parent.layer.close(index);
	            			});
		            	}else if(data.code == "0" || data.code == "-1") {
		            		layer.msg(data.msg, {offset: ['50%'], time: 2000},function(){
		            			//parent.window.closeTab(data.taskId);
		            			index = parent.layer.getFrameIndex(window.name);
						    	parent.layer.close(index);
		            		});
		            	}else {
		            		layer.msg("审批失败", {offset: ['50%'], time: 2000});
		            	}
		            },
		            error: function (data) {
		            	layer.close(index);
		                layer.msg("服务端异常");
		            }
		      });
			} else {
				layer.msg("请选择审批人", {offset: ['50%'], time: 2000});
			}
			return false;
		});
	} else if(formkey == 'mailregistration_usertask2.html'){
		
		getSprs();
		
		//审批
		form.on('submit(sp)', function(data){
			if(sprs.length > 0){
				data.field.sprs = sprs.join(",")
				data.field.usersprs = usersprs.join(",")
				data.field.id = "${USER.u_id}mailregistration${formkey!''}";
				data.field.bk = "${bk!''}";
				data.field.agree = "true";
				$.ajax({
		            type: "post",
		            data: data.field,
		            url: "${ctx}/grgzt/dbsx/complete/${taskId!''}",
		            beforeSend: function () {
		                index = layer.load(1);
		            },
		            success: function (data) {
		            	layer.close(index);
		            	if(data.code >0){
		            		index = layer.confirm("审批成功,下一流程节点："+data.msg, {
		            			  closeBtn:0,
		            			  btn: ['确定'] //按钮
		            			}, function(){
		            			index = parent.layer.getFrameIndex(window.name);
						    	parent.layer.close(index);
	            			});
		            	}else if(data.code == "0" || data.code == "-1") {
		            		layer.msg(data.msg, {offset: ['50%'], time: 2000},function(){
		            			index = parent.layer.getFrameIndex(window.name);
						    	parent.layer.close(index);
		            		});
		            	}else {
		            		layer.msg("审批失败", {offset: ['50%'], time: 2000});
		            	}
		            },
		            error: function (data) {
		            	layer.close(index);
		                layer.msg("服务端异常");
		            }
		      });
			} else {
				layer.msg("请选择审批人", {offset: ['50%'], time: 2000});
			}
			return false;
		});
	}else if(formkey == 'mailregistration_usertask3.html'){
		
		form.on('submit(sp)', function(data){
			data.field.id = "${USER.u_id}mailregistration${formkey!''}";
			data.field.bk = "${bk!''}";
			data.field.agree = "true";
			$.ajax({
	            type: "post",
	            data: data.field,
	            url: "${ctx}/grgzt/dbsx/complete/${taskId!''}",
	            beforeSend: function () {
	                index = layer.load(1);
	            },
	            success: function (data) {
	            	layer.close(index);
	            	if(data.code >0){
	            		index = layer.confirm("审批成功,下一流程节点："+data.msg, {
	            			  closeBtn:0,
	            			  btn: ['确定'] //按钮
	            			}, function(){
	            			//parent.window.closeTab(data.taskId);
	            			index = parent.layer.getFrameIndex(window.name);
					    	parent.layer.close(index);
            			});
	            	}else if(data.code == "0" || data.code == "-1") {
	            		layer.msg(data.msg, {offset: ['50%'], time: 2000},function(){
	            			//parent.window.closeTab(data.taskId);
	            			index = parent.layer.getFrameIndex(window.name);
					    	parent.layer.close(index);
	            		});
	            	}else {
	            		layer.msg("审批失败", {offset: ['50%'], time: 2000});
	            	}
	            },
	            error: function (data) {
	            	layer.close(index);
	                layer.msg("服务端异常");
	            }
	        });
			return false;
		});
	}
    
	$("#spr_add").click(function(){
		 layer.open({
            type: 2,
            area: ['722px', '516px'],
         	title: false,
            fixed: false, //不固定
            content: '${ctx}/grgzt/fqlc/spr?key=mailregistration&formkey=${formkey!''}',
            end: function(){
            	getSprs();
       	    }
   	   })
	})

	function getSprs(){
		$.ajax({
            type: "post",
            data: {id:"${USER.u_id}mailregistration${formkey!''}"},
            url: "${ctx}/grgzt/fqlc/getSprs",
            beforeSend: function () {
                index = layer.load(1);
            },
            success: function (data) {
            	layer.close(index);
            	var html = ""
        		sprs = [];
            	usersprs = [];
            	$.each(data,function(i,v){
            		sprs.push(v.oiduid.split("#")[1]);
            		usersprs.push(v.oiduid);
            		html +='<div class="spr-select">';
            			html +='<i class="fa fa-close spr-close" data-id="'+v.oiduid+'"></i>';
						html +='<div class="spr-box">'
							html +='<p>'+v.o_name+'</p>';
							html +='<p>'+v.j_name+'</p>';
						html +='</div>';
						html +='<p>'+v.nickname+'</p>';
					html +='</div>';
            	})
            	
            	$("#spr_add").prevAll().remove();
            	$("#spr_add").before(html);
            	$("#spr .spr-select").on('click','.spr-close',function () { 
            		var oiduid = $(this).attr("data-id");
            		usersprs.remove(oiduid)
            		sprs.remove(oiduid.split("#")[1])
            		$(this).parent().remove();
            	})
            },
            error: function (data) {
            	layer.close(index);
                layer.msg("服务端异常");
            }
      });
}
</script>
</html>