<#assign ctx=req.contextPath />
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link href="${ctx}/plugins/layui/css/layui.css" rel="stylesheet"/>
    <link href="${ctx}/plugins/font-awesome/css/font-awesome.css" rel="stylesheet"/>
    <style type="text/css">
        /* layui重置 */
        .layui-form {
            width: 600px;
            margin: 10px auto 0;
        }

        .layui-form-item {
            display: flex;
            align-items: flex-start;
        }
        .layui-form-label{width: 130px;}
        .layui-form-item .layui-inline, .layui-form-item .layui-input-block {
            width: 450px;
        }

        .layui-form-item > a {
            display: inline-block;
            height: 36px;
            line-height: 36px;
        }

        .layui-form-item .radio-box {
            border: 1px solid #e6e6e6;
        }

        .layui-btn-container {
            width: 600px;
            margin: 0 auto;
            text-align: center;
        }

        /* 自定义 */
        div.icon-box {
            height: 36px;
            border: 1px solid #e6e6e6;
            border-left: none;
            background-color: #fff;
            border-radius: 2px;
        }

        .icon-box .icon {
            width: 36px;
            height: 36px;
            text-align: center;
            line-height: 36px;
            border-right: 1px solid #e6e6e6;
            display: inline-block;
        }

        .icon-box .layui-inline-block {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .icon-box .icon-input {
            display: inline-block;
            border: none;
            flex-grow: 1;
            padding: 0 10px;
        }

        .layui-form-item {
            margin-bottom: 10px;
        }

        .main {
            width: 800px;
            margin: 1% auto 0;
        }

        .img-up-box, #spr {
            max-width: 500px;
            height: auto;
            display: flex;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .img-up-box .img-box {
            position: relative;
            display: inline-block;
            width: 80px;
            height: 80px;
            border: 1px solid #e6e6e6;
            margin-right: 8px;
            margin-top: 8px;
        }

        .img-up-box .img-box .img-close {
            position: absolute;
            top: -7px;
            right: -7px;
            font-size: 12px;
            color: #fff;
            border-radius: 20px;
            width: 16px;
            height: 16px;
            background-color: #000;
            text-align: center;
            line-height: 16px;
        }

        .img-up-box .img-box > img {
            width: 100%;
            height: 100%;
        }

        #img_up, #spr_add {
            width: 80px;
            height: 80px;
            border: 1px solid #e6e6e6;
            text-align: center;
            line-height: 80px;
            font-size: 28px;
            color: #e6e6e6;
            background-color: #fff;
        }
        #spr_add1 {
            width: 80px;
            height: 80px;
            border: 1px solid #e6e6e6;
            text-align: center;
            line-height: 80px;
            font-size: 28px;
            color: #e6e6e6;
            background-color: #fff;
        }

        #spr {
            align-items: flex-start;
        }

        #spr_add {
            width: 70px;
            height: 70px;
            line-height: 70px;
            border-radius: 1000px;
        }
        #spr_add1 {
            width: 70px;
            height: 70px;
            line-height: 70px;
            border-radius: 1000px;
        }

        .spr-select {
            text-align: center;
            position: relative;
            margin-right: 15px;
            display: inline-block;
        }

        .spr-box {
            color: #fff;
            text-align: center;
            background-color: cornflowerblue;
            border-radius: 1000px;
            font-size: 12px;
            width: 70px;
            height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .spr-close {
            cursor: pointer;
            position: absolute;
            top: 0;
            right: -7px;
            font-size: 12px;
            color: #fff;
            border-radius: 20px;
            width: 16px;
            background-color: #000;
            text-align: center;
            line-height: 16px;
        }

        #layer-photos {
            display: flex;
            align-items: center;
            max-width: 500px;
            flex-wrap: wrap;
        }
        #layer-photos img {
            width: 80px;
            height: 80px;
            display: block;
            margin-right: 5px;
            margin-bottom: 5px;
        }

    </style>
</head>
<body>

<form class="layui-form" lay-filter="edit" style="margin: 5% auto 0;">
    <div class="layui-form-item">
        <label class="layui-form-label">工作内容：</label>
        <div class="layui-inline">
            <textarea name="work_content" placeholder="请输入内容" class="layui-textarea" lay-verify="required"></textarea>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">选择图片：</label>
        <input type="text" name='imgName' class="layui-hide" value="">
        <div class="layui-inline img-up-box">
            <button type="button" id="img_up"><i class="fa fa-plus"></i></button>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">主要负责人：</label>
        <div class="layui-inline" id="spr1">
            <div id="spr_add1">
                <i class="fa fa-plus"></i>
            </div>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">接收人：</label>
        <div class="layui-inline" id="spr">
            <div id="spr_add">
                <i class="fa fa-plus"></i>
            </div>
        </div>
    </div>

    <div class="layui-btn-container">
        <a class="layui-btn  layui-btn-primary" lay-submit lay-filter="save">保存</a>
        <a id="cancel" class="layui-btn  layui-bg-gray">取消</a>
    </div>
    </div>
</form>

<script src="${ctx}/plugins/layui/layui.js"></script>
<script type="text/javascript">

    layui.config({
        base: '${ctx}/plugins/layui/extend/dtree/'
    }).extend({
        dtree: 'dtree'
    })

    layui.use(['form', 'layer', 'dtree', 'upload', 'laydate'], function () {
        var dtree = layui.dtree;

        var $ = layui.jquery, treeSelect = layui.treeSelect, form = layui.form, layer = layui.layer;

        form.on('submit(save)', function (data) {
            var url = "${ctx}/swgl/clgl/editCar";
            data.field.c_id = '${(car.c_id)!''}';
            var index;
            $.ajax({
                type: "POST",
                data: data.field,
                url: url,
                beforeSend: function () {
                    index = layer.load(1);
                },
                success: function (data) {
                    layer.close(index);
                    if (data > 0) {
                        var msg = "保存成功";
                        layer.msg(msg, {offset: ['50%'], time: 1000}, function () {
                            index = parent.layer.getFrameIndex(window.name);
                            parent.layer.close(index);
                        });
                    } else {
                        layer.msg("操作失败")
                    }
                },
                error: function (data) {
                    layer.msg("服务端异常");
                }
            });
            return false;
        });

        //取消
        $("#cancel").click(function () {
            var index = parent.layer.getFrameIndex(window.name);
            parent.layer.close(index);
        })

        //主要负责人
        $("#spr_add").click(function () {
            layer.open({
                type: 2,
                area: ['722px', '516px'],
                title: false,
                fixed: false, //不固定
                // btn:['确定','取消'],
                // btnAlign: 'c',
                content: '${ctx}/swgl/gzrz/empTree?key=journal&formkey=principal',
                end: function () {
                    getSprs("spr_add","spr","principal");
                }
            })
        })

        //接收人
        $("#spr_add1").click(function () {
            layer.open({
                type: 2,
                area: ['722px', '516px'],
                title: false,
                fixed: false, //不固定
                // btn:['确定','取消'],
                // btnAlign: 'c',
                content: '${ctx}/swgl/gzrz/empTree?key=journal&formkey=receiver',
                end: function () {
                    getSprs("spr_add1","spr1","receiver");
                }
            })
        })
        function getSprs(ele,ele1,ele2){
            $.ajax({
                type: "post",
                data: {id:"${user.u_id}journal"+ele2},
                url: "${ctx}/grgzt/fqlc/getSprs",
                beforeSend: function () {
                    index = layer.load(1);
                },
                success: function (data) {
                    console.log("success");
                    console.log(data);
                    layer.close(index);
                    var html = ""
                    var sprs = [];
                    $.each(data,function(i,v){
                        sprs.push(v.u_id);
                        html +='<div class="spr-select">';
                        html +='<i class="fa fa-close spr-close" data-id="'+v.u_id+'"></i>';
                        html +='<div class="spr-box">'
                        html +='<p>'+v.o_name+'</p>';
                        html +='<p>'+v.j_name+'</p>';
                        html +='</div>';
                        html +='<p>'+v.nickname+'</p>';
                        html +='</div>';
                    })

                    $("#"+ele).prevAll().remove();
                    $("#"+ele).before(html);
                    $("#"+ele1+" .spr-select").on('click','.spr-close',function () {
                        sprs.remove($(this).attr("data-id"))
                        $(this).parent().remove();
                    })
                },
                error: function (data) {
                    layer.close(index);
                    layer.msg("服务端异常");
                }
            });
        }


    })
</script>
</body>
</html>
