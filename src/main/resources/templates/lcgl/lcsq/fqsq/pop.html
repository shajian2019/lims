<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>新增</title>
    <link href="${ctx}/plugins/layui/css/layui.css" rel="stylesheet" />
 	<link rel="stylesheet" href="${ctx}/plugins/layui/extend/dtree/dtree.css">
    <link rel="stylesheet" href="${ctx}/plugins/layui/extend/dtree/font/dtreefont.css">
    <link rel="stylesheet" href="${ctx}/plugins/font-awesome/css/font-awesome.min.css" media="all" />
    <style>
        #search_input{width:220px;display:inline-block;height:31px;line-height:31px;}
        .form-box{display: flex;align-items: center;width: 675px;margin: 10px auto 0;flex-wrap: nowrap;}
        .form-l,.form-r{border:1px solid #e6e6e6;height:450px;width:326px;overflow: auto;}
        .tit{background-color: #f3f5f7;line-height:30px;border-bottom: 1px solid #e6e6e6;padding:0 12px;}
        .tit-r{display: flex;align-items: center;justify-content: space-between;}
        #r_list li{display: flex;align-items: center;justify-content: space-between;padding: 8px 15px;margin-bottom: 4px;}
        #r_list li:hover{background-color: #e6e6e6;}
        #r_list li:hover .layui-icon-close-fill{color:#ff5722;}
        .num,#all_clear{color:#1E9FFF;}
        .layui-btn{background-color: #0a8cbf;}
        /* zdy主题风格*/
        .dtree-zzfc-item-this{background-color: #c2c2c2!important;} /* 当前选中行样式*/
        .dtree-zzfc-item:hover{background-color: #f2f2f2!important;} /* 行悬停样式*/
        .dtree-zzfc-item cite{font-size:14px!important;} /* 行文字样式*/
        .dtree-zzfc-item:hover cite{color:#1E9FFF!important;} /* 行悬停文字样式*/
        .dtree-zzfc-dtreefont{font-size: 18px!important;} /* 一级图标、二级图标、复选框样式*/
        .dtree-zzfc-ficon{color:#2F4056!important;}  /*一级图标特定样式*/
        .dtree-zzfc-icon{color:#1E9FFF!important;}  /*二级图标特定样式*/
        .dtree-zzfc-checkbox:hover{color:#1E9FFF!important;}  /*复选框悬停样式*/
        .dtree-zzfc-choose{color:#1E9FFF!important;} /* 复选框选中样式*/
    </style>
</head>

<body>
    <form class="layui-form">
        <div class="form-box">
            <div class="form-l">
                <p class="tit">所有部门</p>
                <div class="layui-input-block" style="width:280px;margin: 10px auto 0;">
                    <input class="layui-input" id="search_input" value="">
                    <a class="layui-btn layui-btn-sm layui-btn-normal" id="search_btn" style="display:inline-block;">搜索</a>
                </div>
                <ul id="popTree" class="dtree" data-id="0"></ul>
            </div>
            <i class="layui-icon layui-icon-next" style="padding:0 5px;"></i>
            <div class="form-r">
                <p class="tit tit-r">
                    <span>已经选择<span class="num">(<span id="selected_num">0</span>)</span></span>
                    <a href="javascript:;" id="all_clear">全部清除</a>
                </p>
                <ul id="r_list"></ul>
            </div>
        </div>
        <div style="text-align: center;width:100%;padding-top:10px;">
            <a href="javascript:;" class="layui-btn layui-btn-sm" lay-submit lay-filter="save">保存</a>
            <a href="javascript:;" class="layui-btn layui-btn-sm closeBtn layui-bg-gray">取消</a>
        </div>
    </form>
</body>
</html>

<script src="${ctx}/plugins/layui/layui.js"></script>
<script type="text/javascript">
    layui.config({
        base: '${ctx}/plugins/layui/extend/dtree/'
    }).extend({
        dtree: 'dtree'
    })
    layui.use(['element', 'layer', 'dtree', 'form'], function () {
        var $ = layui.jquery,
            form = layui.form,
            layer = layui.layer,
            dtree = layui.dtree;
        
        //treedemo变量配置
        var dtreeID = "popTree";
        var dtreeSkin = "zzfc";
        var treeUrl = "${ctx}/lcgl/lcdy/lcfl/list";
        var searchBtn = $("#search_btn");
        var searchInput = $("#search_input");
        var rList = $("#r_list");
        var selectedNum = $("#selected_num");
        var allClear = $("#all_clear");
        
        //弹出框树
        var popTree = dtree.render({
            elem: "#" + dtreeID,
            nodeIconArray: { "2": { "open": "fa fa-address-book", "close": "fa fa-address-book" } },
            skin: 'zzfc',
            method: 'GET',
            url:"${ctx}/orgUser/list?p_id=${p_id}",
            type:'all',
            icon: ["2", "1"],
            dot: false,
            checkbar: true,
            checkbarFun:{
                chooseDone: function(checkbarNodesParam) { //复选框点击事件完毕后，返回该树关于复选框操作的全部信息。
                    addPersonnel(checkbarNodesParam);
                    return false;
                }
            },
            done:function(data, obj){
            	var params = dtree.getCheckbarNodesParam("popTree");
                //dtree.chooseDataInit("demoTree", "001,002,003");
                console.log(data,obj)
                console.log(params)
            	addPersonnel(params);
            }
        })

        form.on('submit(save)', function (data) {
        	var params = dtree.getCheckbarNodesParam(popTree);
        	if(params.length == 0){
        		layer.msg("请选择用户", {offset: ['50%'], time: 2000});
        	} else {
        		var arr = [];
            	$.each(params, function (i, v) {
            		if(v.level == '2'){
            			arr.push(v.nodeId)
            		}
                });
            	var u_ids = arr.join(",");
            	var p_id = "${p_id}";
            	var index;
            	$.ajax({
                    type: "POST",
                    data:{u_ids:u_ids,p_id:p_id},
                    url: "${ctx}/lcgl/lcsq/fqsq/bindUser",
                    beforeSend: function () {
                        index = layer.load(1);
                    },
                    success: function (data) {
                        layer.close(index);
                        layer.msg("保存成功", {offset: ['50%'], time: 1000}, function () {
	                        dtree.reload(popTree)
                        });
                    },
                    error: function (data) {
                        layer.msg("服务端异常");
                    }
             	});
        	}
            return false;
        });
        
        //数组对象对应删除
        Array.prototype.remove = function (val) {
            var index = this.indexOf(val);
            if (index > -1) {
                this.splice(index, 1);
            }
        };
        //右侧人员删除
        rList.on("click", ".layui-icon-close-fill", function (obj) {
            var element = $(this)
            delPersonnel(element);
        });
        
        //右侧清楚全部
        allClear.click(function (e) {
            allClearPersonnel();
            dtree.chooseDataInit("popTree", '');
            /* dtree.reload(popTree, {
                done: function (data, obj) {
                    dtree.chooseDataInit("popTree", '');
                }
            }); */
        });
        searchBtn.click(function () {
            search();
        })

        function addPersonnel(obj) {
            var html = '';
            $.each(obj, function (i, val) {
                if (val.isLeaf === true) {
                    html += "<li><p>" + val.context +
                        "</p><i class='layui-icon layui-icon-close-fill del-p' data-id='" + val.nodeId +
                        "'></i></li>";
                }
            });
            rList.html(html);
            var staff = rList.find('li').length;
            selectedNum.text(staff);
        }

        function delPersonnel(e) {
            var del = e.attr("data-id");
            var w_id = "";
            rList.find("li").each(function () {
                w_id += $(this).find("i").attr("data-id") + ",";
                if (w_id.substr(w_id.length - 1) == ',') {
                    nodeId = w_id.substr(0, w_id.length - 1);
                }
            });
            var arr = nodeId.split(",");
            arr.remove(del);
            var nodeId = arr.join(",");
            dtree.chooseDataInit("popTree", nodeId);
            /* dtree.reload(popTree, {
                done: function (data, obj) {
                    dtree.chooseDataInit(popTree, nodeId);
                }
            }) */
            e.parent().remove();
            selectedNum.text(rList.find("li").length);
        }

        function allClearPersonnel() {
            rList.empty();
            selectedNum.text("0");
        }
        
        function search() {
            var value = searchInput.val();
            var node = $("cite.t-click");
            if (value != "") {
                $("#popTree").children().addClass("layui-hide")
                $.each(node, function (i, v) {
                    var nodeTxt = $(this).text();
                    var data_leaf = $(this).attr("data-leaf");
                    var data_id = $(this).attr("data-id");
                    if (nodeTxt.indexOf(value) != -1) {
                        $(this).parents('').removeClass("layui-hide")
                    }
                });
            } else {
                $("#popTree").children().removeClass("layui-hide")
            }
        }
});

</script>