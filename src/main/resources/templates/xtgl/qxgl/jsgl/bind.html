<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>弹出框</title>
    <link href="${ctx}/plugins/layui/css/layui.css" rel="stylesheet" />
</head>
<body>	
	  <form class="layui-form">
			<div class="layui-form-item">
		        <div class="layui-inline">
		        	<button class="layui-btn layui-btn-primary" lay-submit="" lay-filter="add">添加用户</button>
		        	<button class="layui-btn layui-btn-primary" lay-submit="" lay-filter="cancel">关闭</button>
		        </div>
			</div>
	  </form>
      <table class="layui-hide" id="test"></table>
</body>

</html>
<script src="${ctx}/plugins/layui/layui.all.js"></script>
<script>
layui.use(['table','layer','form','jquery'], function(){
	  var tableId = "test";
	  var table = layui.table,
	  	  layer = layui.layer,
	  	  $ = layui.jquery,
	 	  form = layui.form;
	  table.render({
	     elem: '#'+tableId
	    ,url:'${ctx}/xtgl/zzgl/yhgl/getAllUsers?status=3'
	    ,cellMinWidth: 80
	    ,cols: [[
	      {type:'checkbox', width:60},
	      {field:'username', width:140, title: '用户账号'},
	      {field:'nickname', width:120, title: '用户昵称'},
	      {field:'createtime', width:180, title: '创建时间'},
	      {field:'phone', width:130, title: '手机号码'},
	      {field:'email', width:200, title: '邮箱'},
	      {field:'remark',title: '备注'}
	    ]]
	    ,id: tableId
	    ,page: true
	    ,height: 'full-70'
	  });
	  
	  form.on('submit(cancel)', function(data){
		  var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
		  parent.layer.close(index);
          return false;
      });
	  
	  form.on('submit(add)', function(data){
		  var checkStatus = table.checkStatus(tableId);
		  var length = checkStatus.data.length;
		  if(length > 0){
			 var data = checkStatus.data;
		 	 var paramStr = "";
		 	 data.forEach(function(e){  
	        	 paramStr +=e.u_id+"|"
	         });
	 		 var index;
             $.ajax({
    		    type: "post",
    		    data: {paramStr:paramStr,r_id:'${param.r_id}'},
    		    url: '${ctx}/xtgl/qxgl/jsgl/role/bindUser',
    		    beforeSend: function () {
    		    	index = layer.load(1);
    		    },
    		    success: function (data) {
    		    	layer.close(index)
    		    	var msg = "";
    		    	if(data > 0){
    		    		msg = "保存成功";
    		    	}else{
    		    		msg = "保存失败";
    		    	}
    		    	layer.msg(msg,{offset:['50%'],time: 1000},function(){
    		    		index = parent.layer.getFrameIndex(window.name);
				    	parent.layer.close(index);
                    });
    		    },
    		    error: function (data) {
    		    	layer.close(index)
    		    	layer.msg("服务器异常",{icon:2});
    		    }
    		 });
		  }else{
			  layer.msg('请选择用户',{offset:['50%'],time: 2000});
		  }
          return false;
      });
	  
});
</script>