<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>组织机构</title>
    <link href="${ctx}/plugins/layui/css/layui.css" rel="stylesheet" />
    <link href="${ctx}/css/common/reset.css" rel="stylesheet" />
    <link href="${ctx}/plugins/font-awesome/css/font-awesome.css" rel="stylesheet" />
	<style>
	    .layui-table, .layui-table-view {
		    margin: 0px;
		}
		#cdgl_form{margin-bottom: 5px;}
		#pop{padding-top: 8px;}
		#pop .layui-form-item{display: flex;align-items: center;}
		#pop .layui-form-label{width: 144px;text-align: right;}
		#pop .layui-inline{width: 400px;}
		.layui-btn-container{text-align: center;}
	</style>
</head>
<body class="layui-layout-body" style="padding: 5px">
<form class="layui-form" id="cdgl_form">
       <div class="layui-inline">
       		<input class="layui-input" type="text" placeholder="单位（科室）名称" name="likename">		
       </div>
       <div class="layui-inline">
	       	<button class="layui-btn layui-btn-primary" lay-submit="" lay-filter="query">查询</button>
	 	 	<a class="layui-btn layui-btn-primary" onclick="add();">新增</a>
	 	 	<a class="layui-btn layui-btn-primary" onclick="openAll();">展开/折叠</a>
	       	<button class="layui-btn layui-btn-primary" lay-submit="" lay-filter="updateSort">保存排序</button>
       </div>
</form>
    <table class="layui-hidden layui-table" id="treeTable" lay-filter="treeTable"></table>
    
    <!-- 新增 修改 -->
    <div class="pop" id="pop" style="display: none;">
		<form class="layui-form" lay-filter="pop">
		      <div class="layui-form-item">
		         <label class="layui-form-label">单位（科室）名称</label>
		         <div class="layui-inline">
		            <input class="layui-input" type="text" name="name" placeholder="单位（科室）名称" lay-verify="required">
		         </div>
			   </div>
		      <div class="layui-form-item">
		         <label class="layui-form-label">排序</label>
		         <div class="layui-inline">
		            <input class="layui-input" type="text" name="sort" placeholder="排序" lay-verify="required|number">
		         </div>
			   </div>
		      <div class="layui-form-item">
		         <label class="layui-form-label">备注</label>
		            <div class="layui-inline">
		             	<textarea class="layui-textarea" name="remark" placeholder="备注"></textarea>
		         	</div>
			   </div>
			   <!-- <div class="layui-form-item">
			        <label class="layui-form-label">状态:</label>
			        <div class="layui-input-block radio-box">
				          <input type="radio" name="status" value="1" title="正常" checked>
				          <input type="radio" name="status" value="0" title="禁用">
			        </div>
			    </div> -->
			    <input type="hidden" name="status" value="1">
			    <div class="layui-btn-container">
  					<a class="layui-btn layui-btn-sm layui-btn-primary" lay-submit lay-filter="saveOrUpdate">保存</a>
				</div>
		</form>
	</div>
</body>
</html>
<script type="text/html" id="status" >
{{# if (d.status == 1) { }}
     <span>正常</span>
{{# } else { }}
    <span>禁用</span>
{{# } }}
</script>
<script src="${ctx}/plugins/layui/layui.js"></script>
<script>
    var editObj=null,ptable=null,treeGrid=null,tableId='treeTable',layer=null,form=null,index = null,$ = null;
    layui.config({
        base: '${ctx}/plugins/layui/extend/'
    }).extend({
        treeGrid:'treeGrid'
    }).use(['jquery','treeGrid','layer','form'], function(){
        $ = layui.jquery;
        treeGrid = layui.treeGrid;//很重要
        layer=layui.layer;
        form=layui.form;
        ptable=treeGrid.render({
            id:tableId
            ,elem: '#'+tableId
            ,idField:'id'
            ,url:'${ctx}/xtgl/zzgl/zzjg/list'
            ,treeId:'id'//树形id字段名称
            ,treeUpId:'parentid'//树形父id字段名称
            ,treeShowName:'name'//以树形式显示的字段
            ,height:'full-50'
            ,isFilter:false
            ,iconOpen:true//是否显示图标【默认显示】
            ,isOpenDefault:true//节点默认是展开还是折叠【默认展开】
            ,method:'get'
            ,cols: [[
                 {field:'name', width:400, title: '单位（科室）名称'}
                ,{field:'createtime', width:200, title: '创建时间',align:'center'}
                ,{field:'remark', title: '备注'}
                ,{field:'status', width:100, title: '状态',align:'center',templet:'#status'}
                ,{field:'sort', width:100, title: '排序',align:'center',edit:'text'}
                ,{title: '操作', align:'center',width:140,templet: function(d){
                        var html='';
                        	html +='<button class="layui-btn layui-btn-primary layui-btn-xs" lay-event="edit"><i class="fa fa-pencil" title="修改"></i></button>';
                        	html +='<button class="layui-btn layui-btn-primary layui-btn-xs" lay-event="del"><i class="fa fa-trash-o" title="删除"></i></button>';
                        if(d.level != '2'){
                        	html +='<button class="layui-btn layui-btn-primary layui-btn-xs" lay-event="add"><i class="fa fa-plus-square-o" title="新增"></i></button>';
                        }
                        return html;
                    }
                }
            ]]
        });
        
        //点击行事件
        treeGrid.on('tool('+tableId+')',function (obj) {
        	var objdata = obj.data;
        	var action = obj.event;
        	if(action == 'del'){
        		index = layer.confirm('确定删除该单位（科室）吗?', function (index) {
        			$.ajax({
          			    type: "post",
          			    data: objdata,
          			    url: "${ctx}/xtgl/zzgl/zzjg/del",
          			    beforeSend: function () {
          			    	index = layer.load(1);
          			    },
          			    success: function (data) {
          			    	layer.close(index);
          			    	if(data > 0){
          			    		layer.msg("删除成功",{offset:['50%'],time: 1000},function(){
          			    			layer.closeAll();
          			    			treeGrid.reload(tableId)
          	                    });
          			    	}else{
          			    		layer.msg("删除失败")
          			    	}
          			    },
          			    error: function (data) {
          			    	layer.close(index);
          			    	layer.msg("服务端异常");
          			    }
          		 	});
           		})
        	}else if(action == 'add'){
        		form.on('submit(saveOrUpdate)', function(data){
		        	data.field.level = (parseInt(objdata.level)+1)+"";
		        	data.field.parentid = objdata.id;
		        	$.ajax({
          			    type: "post",
          			    data: data.field,
          			    url: "${ctx}/xtgl/zzgl/zzjg/saveOrUpdate",
          			    beforeSend: function () {
          			    	index = layer.load(1);
          			    },
          			    success: function (data) {
          			    	layer.close(index);
          			    	if(data > 0){
          			    		layer.msg("新增成功",{offset:['50%'],time: 1000},function(){
          			    			layer.closeAll();
          	                    });
          			    	}else if(data == -1){
          			    		layer.msg("此单位（科室）名称已存在")
          			    	}else{
          			    		layer.msg("新增失败")
          			    	}
          			    },
          			    error: function (data) {
          			    	layer.msg("服务端异常");
          			    }
          		 	});
		            return false;
		        });
        		index = layer.open({
     	            title: '新增',
     	            type: 1,
     	            area: ['600px', '380px'],
     	            fixed: false,
     	            content: $("#pop"),
     	            end: function () {
     	            	form.val("pop",{
		    				name:'',
		    				sort:'',
		    				status:'1',
		    				remark:''
		    			});
     	            	treeGrid.reload(tableId)
     	            }
     	        });
        	}else if(action == 'edit'){
        		form.on('submit(saveOrUpdate)', function(data){
		        	data.field.id = objdata.id;
		        	data.field.parentid = objdata.parentid;
		        	$.ajax({
          			    type: "post",
          			    data: data.field,
          			    url: "${ctx}/xtgl/zzgl/zzjg/saveOrUpdate",
          			    beforeSend: function () {
          			    	index = layer.load(1);
          			    },
          			    success: function (data) {
          			    	layer.close(index);
          			    	if(data > 0){
          			    		layer.msg("修改成功",{offset:['50%'],time: 1000},function(){
          			    			layer.closeAll();
          	                    });
          			    	}else if(data == -1){
          			    		layer.msg("此单位（科室）名称已存在")
          			    	}else{
          			    		layer.msg("修改失败")
          			    	}
          			    },
          			    error: function (data) {
          			    	layer.close(index);
          			    	layer.msg("服务端异常");
          			    }
          		 	});
		            return false;
		        });
        		
        		form.val("pop",{
	    				name:objdata.name,
	    				sort:objdata.sort,
	    				remark:objdata.remark,
	    				status:objdata.status
	    		});
        		index = layer.open({
     	            title: '修改',
     	            type: 1,
     	            area: ['600px', '380px'],
     	            fixed: false,
     	            content: $("#pop"),
     	            end: function () {
     	            	form.val("pop",{
		    				name:'',
		    				sort:'',
		    				status:'1',
		    				remark:''
		    			});
     	            	treeGrid.reload(tableId)
     	            }
     	        });
        	}
        });
        
        form.on('submit(query)', function(data){
        	console.log(data.field)
        	treeGrid.reload(tableId,{
        		where:data.field
            });
            return false;
        });
        
        form.on('submit(updateSort)', function(data){
            var map=treeGrid.getDataMap(tableId);
            var array = [];
            for(var item in map){
     	        var json = {};
             	json.id = item;
             	json.sort = map[item].sort
             	array.push(json)
            }
            var index;
            $.ajax({
    		    type: "post",
    		    data: {ids:JSON.stringify(array)},
    		    url: '${ctx}/xtgl/zzgl/zzjg/updateSort',
    		    beforeSend: function () {
    		    	index = layer.load(1);
    		    },
    		    success: function (data) {
    		    	layer.close(index)
    		    	var msg = "";
    		    	if(data > 0){
    		    		msg = "修改成功";
    		    	}else{
    		    		msg = "修改失败";
    		    	}
    		    	layer.msg(msg,{offset:['50%'],time: 1000},function(){
    		    		 treeGrid.reload(tableId)
                    });
    		    },
    		    error: function (data) {
    		    	layer.close(index)
    		    	layer.msg("服务器异常",{icon:2});
    		    }
    		});
            return false;
        });
    });
    
    function add() {
    	form.on('submit(saveOrUpdate)', function(data){
        	data.field.level = "1";
        	data.field.parentid = "0";
        	$.ajax({
  			    type: "post",
  			    data: data.field,
  			    url: "${ctx}/xtgl/zzgl/zzjg/saveOrUpdate",
  			    beforeSend: function () {
  			    	index = layer.load(1);
  			    },
  			    success: function (data) {
  			    	layer.close(index);
  			    	if(data > 0){
  			    		layer.msg("新增成功",{offset:['50%'],time: 1000},function(){
  			    			layer.closeAll();
  	                    });
  			    	}else if(data == -1){
  			    		layer.msg("此单位（科室）名称已存在")
  			    	}else{
  			    		layer.msg("新增失败")
  			    	}
  			    },
  			    error: function (data) {
  			    	layer.msg("服务端异常");
  			    }
  		 	});
            return false;
        });
    	index = layer.open({
	            title: '新增',
	            type: 1,
	            area: ['600px', '400px'],
	            fixed: false,
	            content: $("#pop"),
	            end: function () {
		            	form.val("pop",{
	    				name:'',
	    				sort:'',
	    				remark:''
	    			});
	            	treeGrid.reload(tableId)
	            }
	    });
    }

    
    function openAll() {
        var treedata=treeGrid.getDataTreeList(tableId);
        treeGrid.treeOpenAll(tableId,!treedata[0][treeGrid.config.cols.isOpen]);
    }
    
</script>