<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>职务管理</title>
    <link href="${ctx}/plugins/layui/css/layui.css" rel="stylesheet" />
     <link href="${ctx}/css/common/reset.css" rel="stylesheet" />
    <link href="${ctx}/plugins/font-awesome/css/font-awesome.css" rel="stylesheet" />
    <style>
		.layui-table, .layui-table-view { margin: 0px; }
		#query{margin-bottom: 5px;}
		#pop{padding-top: 8px;}
		#pop .layui-form-item{display: flex;align-items: center;}
		#pop .layui-form-label{width: 100px;text-align: right;}
		#pop .layui-inline{width: 400px;}
		.layui-btn-container{text-align: center;}
	</style>
</head>
<body class="layui-layout-body" style="padding: 5px">
<form class="layui-form" id="query"lay-filter="query">
        <div class="layui-inline">
            <input class="layui-input" type="text" placeholder="职位名称" name="likename">
        </div>
        <div class="layui-inline">
            <a class="layui-btn layui-btn-primary" lay-submit="" lay-filter="query" datatype="reload">查询</a>
            <a class="layui-btn layui-btn-primary" onclick="add();">新增</a>
            <button class="layui-btn layui-btn-primary" lay-submit="" lay-filter="updateSort">保存排序</button>
        </div>
</form>
<div style="height:100%">
    <table class="layui-hidden layui-table" id="dataTable" lay-filter="dataTable"></table>
    <div class="pop" id="pop" style="display: none;">
		<form class="layui-form" lay-filter="pop">
		      <div class="layui-form-item">
		         <label class="layui-form-label">职务名称</label>
		         <div class="layui-inline">
		            <input class="layui-input" type="text" name="name" placeholder="职务名称" lay-verify="required">
		         </div>
			   </div>
		      <div class="layui-form-item">
		         <label class="layui-form-label">排序</label>
		         <div class="layui-inline">
		            <input class="layui-input" type="text" name="sort" placeholder="排序" lay-verify="required|number">
		         </div>
			   </div>
		      <div class="layui-form-item">
		         <label class="layui-form-label">备注</label>
		            <div class="layui-inline">
		             	<textarea class="layui-textarea" name="remark" placeholder="备注"></textarea>
		         	</div>
			   </div>
			   <div class="layui-form-item">
			        <label class="layui-form-label">状态:</label>
			        <div class="layui-inline radio-box">
				          <input type="radio" name="status" value="1" title="正常" checked>
				          <input type="radio" name="status" value="0" title="禁用">
			        </div>
			    </div>
			    <div class="layui-btn-container">
  					<a class="layui-btn layui-btn-sm layui-btn-primary" lay-submit lay-filter="saveOrUpdate">保存</a>
				</div>
		</form>
	</div>
</div>
</body>
</html>

<script type="text/html" id="rightBar">
    <div class="layui-btn-group">
        <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="edit">
            <i class="fa fa-pencil" title="修改"></i>
        </a>
        <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="del">
            <i class="fa fa-trash-o" title="删除"></i>
        </a>
    </div>
</script>

<script type="text/html" id="status" >
{{# if (d.status == 1) { }}
     <span>正常</span>
{{# } else { }}
    <span>禁用</span>
{{# } }}
</script>

<script src="${ctx}/plugins/layui/layui.js"></script>
<script>
    var editObj = null, ptable = null, treeGrid = null, tableId = 'dataTable', layer = null, form = null,$=null,table = null, index = null;
    layui.use('table', function () {
        table = layui.table;
        $=layui.jquery;
        form = layui.form;
        table.render({
            elem: '#' + tableId
            , url: '${ctx}/xtgl/zzgl/zwgl/list'//后台接受路径
            , page: true
            , id: tableId
            , height: 'full-48'
            , method: 'get'
            , cols: [[
                {field: '序号',width:50,fixed:'left',type:'numbers',title:'序号'}
                , {field: 'u_id', hide:true}
                , {field: 'name', width: 220, title: '职务名称',align: 'center'}
                , {field: 'sort', width: 80, title: '排序',edit:'text',align: 'center'}
                , {field: 'createtime', width: 170, title: '创建时间',align: 'center'}
                , {field: 'remark', title: '备注'}
                , {
                    field: 'status', width: 100, title: '职务状态',align: 'center',
                    templet:"#status"
                },{
                    title: '操作', align: 'center',width: 100,
                    toolbar: '#rightBar'
                }
            ]]
        });
        
        //点击行事件
        table.on('tool(' + tableId + ')', function (obj) {
            var objdata = obj.data;
            var action = obj.event;
            if (action == 'del') {
            	layer.confirm('确定删除该职务吗?', function (index) {
                     $.ajax({
                         type: "post",
                         data: objdata,
                         url: "${ctx}/xtgl/zzgl/zwgl/del",
                         beforeSend: function () {
                             index = layer.load(1);
                         },
                         success: function (data) {
                             layer.close(index);
                             if (data > 0) {
                                 layer.msg("删除成功", {offset: ['50%'], time: 1000}, function () {
                                     table.reload(tableId)
                                 });
                             } else {
                                 layer.msg("操作失败")
                             }
                         },
                         error: function (data) {
                             layer.msg("服务端异常");
                         }
                     });
            	})
            } else if(action == 'edit'){
            	form.val("pop",{
    				name:objdata.name,
    				sort:objdata.sort,
    				status:objdata.status,
    				remark:objdata.remark
    			});
            	form.on('submit(saveOrUpdate)', function(data){
            		data.field.id =objdata.id;
            		console.log(data.field)
                	$.ajax({
          			    type: "post",
          			    data: data.field,
          			    url: "${ctx}/xtgl/zzgl/zwgl/addOrUpdate",
          			    beforeSend: function () {
          			    	index = layer.load(1);
          			    },
          			    success: function (data) {
          			    	layer.close(index);
          			    	if(data > 0){
          			    		layer.msg("修改成功",{offset:['50%'],time: 1000},function(){
          			    			layer.closeAll();
          	                    });
          			    	}else if(data == -1){
          			    		layer.msg("此职位名称已存在")
          			    	}else{
          			    		layer.msg("修改失败")
          			    	}
          			    },
          			    error: function (data) {
          			    	layer.msg("服务端异常");
          			    }
          		 	});
                    return false;
                });
            	index = layer.open({
    	            title: '修改',
    	            type: 1,
    	            area: ['542px', '400px'],
    	            fixed: false,
    	            content: $("#pop"),
    	            end: function () {
    	            	form.val("pop",{
    	    				name:'',
    	    				status:'1',
    	    				sort:'',
    	    				remark:''
    	    			});
    	            	table.reload(tableId);
    	            }
    	     	});
            }
        });

        form.on('submit(query)', function (data) {
            table.reload(tableId, {
                where: data.field
            });
            return false;
        });
        
        var array = [];
        
        table.on('edit('+tableId+')', function(obj){ //注：edit是固定事件名，test是table原始容器的属性 lay-filter="对应的值"
        	  var json = {};
	          json.id = obj.data.id
	          json.sort = obj.value
	          array.push(json)
       	});
        
        form.on('submit(updateSort)', function(data){
        	if(array.length>0){
                $.ajax({
        		    type: "post",
        		    data: {ids:JSON.stringify(array)},
        		    url: '${ctx}/xtgl/zzgl/zwgl/updateSort',
        		    beforeSend: function () {
        		    	index = layer.load(1);
        		    },
        		    success: function (data) {
        		    	layer.close(index)
        		    	var msg = "";
        		    	if(data > 0){
        		    		msg = "修改成功";
        		    	}else{
        		    		msg = "修改失败";
        		    	}
        		    	layer.msg(msg,{offset:['50%'],time: 1000},function(){
        		    		table.reload(tableId, {
        		                where: data.field
        		            });
                        });
        		    },
        		    error: function (data) {
        		    	layer.close(index)
        		    	layer.msg("服务器异常",{icon:2});
        		    }
        		});
        	}
            return false;
        });
    });

    function add() {
    	form.on('submit(saveOrUpdate)', function(data){
    		console.log(data.field)
        	$.ajax({
  			    type: "post",
  			    data: data.field,
  			    url: "${ctx}/xtgl/zzgl/zwgl/addOrUpdate",
  			    beforeSend: function () {
  			    	index = layer.load(1);
  			    },
  			    success: function (data) {
  			    	layer.close(index);
  			    	if(data > 0){
  			    		layer.msg("新增成功",{offset:['50%'],time: 1000},function(){
  			    			layer.closeAll();
  	                    });
  			    	}else if(data == -1){
  			    		layer.msg("此职位名称已存在")
  			    	}else{
  			    		layer.msg("新增失败")
  			    	}
  			    },
  			    error: function (data) {
  			    	layer.msg("服务端异常");
  			    }
  		 	});
            return false;
        });
    	index = layer.open({
	            title: '新增',
	            type: 1,
	            area: ['600px', '400px'],
	            fixed: false,
	            content: $("#pop"),
	            end: function () {
		            form.val("pop",{
	    				name:'',
	    				status:'1',
	    				sort:'',
	    				remark:''
	    			});
	            	table.reload(tableId);
	            }
	    });
    }
</script>