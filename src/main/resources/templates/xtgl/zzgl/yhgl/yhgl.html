<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>用户管理</title>
    <link href="${ctx}/plugins/layui/css/layui.css" rel="stylesheet" />
     <link href="${ctx}/css/common/reset.css" rel="stylesheet" />
    <link href="${ctx}/plugins/font-awesome/css/font-awesome.css" rel="stylesheet" />
    <style>
		.layui-table, .layui-table-view { margin: 0px; }
		#query{margin-bottom: 5px;}
	</style>
</head>
<body class="layui-layout-body" style="padding: 5px">
<form class="layui-form" id="query">
        <div class="layui-inline">
            <input class="layui-input" type="text" placeholder="用户账号" name="username" id="username">
        </div>
        <div class="layui-inline">
            <input class="layui-input" type="text" placeholder="用户昵称" name="nickname" id="nickname">
        </div>
        <div class="layui-inline">
            <a class="layui-btn layui-btn-primary" lay-submit="" lay-filter="query" datatype="reload">查询</a>
            <a class="layui-btn layui-btn-primary" onclick="add();">新增</a>
        </div>
</form>
<div style="height:100%">
    <table class="layui-hidden layui-table" id="dataTable" lay-filter="dataTable"></table>
</div>
</body>
</html>

<script type="text/html" id="rightBar">
    <div class="layui-btn-group">
        <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="edit">
            <i class="fa fa-pencil" title="修改"></i>
        </a>
		{{# if(d.username != 'superadmin' ) { }}
        	<a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="del">
            	<i class="fa fa-trash-o" title="删除"></i>
        	</a>
			<a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="reset">
            	<i class="fa fa-rotate-left" title="重置密码"></i>
        	</a>
		{{# } }}
    </div>
</script>

<script type="text/html" id="switch" >
		{{# if(d.username == 'superadmin' ) { }}
    		<input type="checkbox" name="switch" disabled="" lay-skin="switch" lay-filter="switchstatus" lay-text="正常|锁定" checked>
		{{# } else { }}
    		<input type="checkbox" name="switch" lay-skin="switch" lay-filter="switchstatus" lay-text="正常|锁定" {{ d.status == '0' ? 'checked' : '' }}>
		{{# } }}
</script>
<script src="${ctx}/plugins/layui/layui.js"></script>
<script>
    var editObj = null, ptable = null, treeGrid = null, tableId = 'dataTable', layer = null, form = null,$=null;
    layui.use('table', function () {
        var table = layui.table;
        $=layui.jquery;
        form = layui.form;
        table.render({
            elem: '#' + tableId
            , url: '${ctx}/xtgl/zzgl/yhgl/getAllUsers'//后台接受路径
            , page: true
            , id: tableId
            , height: 'full-48'
            , method: 'get'
            , cols: [[
                {field: '序号',width:50,fixed:'left',type:'numbers',title:'序号'}
                , {field: 'u_id', hide:true}
                , {field: 'username', width: 120, title: '用户账号',align: 'center'}
                , {field: 'nickname', width: 120, title: '用户昵称',align: 'center'}
                , {field: 'rolename', width: 120, title: '角色名称',align: 'center'}
                , {field: 'createtime', width: 170, title: '创建时间',align: 'center'}
                , {field: 'email', width: 180, title: '邮件地址',align: 'center'}
                , {field: 'phone', width: 140, title: '手机号码',align: 'center'}
                , {field: 'remark', title: '备注'}
                , {
                    field: 'status', width: 100, title: '用户状态',align: 'center',
                    templet:"#switch"
                },{
                    title: '操作', align: 'center',width: 100,
                    toolbar: '#rightBar'
                }
            ]]
        });
        
        //点击行事件
        table.on('tool(' + tableId + ')', function (obj) {
            var data = obj.data;
            console.log(data)
            var action = obj.event;
            if (action == 'del') {
            	layer.confirm('确定删除该用户吗?', function (index) {
            		 var index;
                     $.ajax({
                         type: "post",
                         data: {u_id: data.u_id},
                         url: "${ctx}/xtgl/zzgl/yhgl/delUserByid",
                         beforeSend: function () {
                             index = layer.load(1);
                         },
                         success: function (data) {
                             layer.close(index);
                             if (data > 0) {
                                 layer.msg("删除成功", {offset: ['50%'], time: 1000}, function () {
                                     table.reload(tableId)
                                 });
                             } else {
                                 layer.msg("操作失败")
                             }
                         },
                         error: function (data) {
                             layer.msg("服务端异常");
                         }
                     });
            	})
            } else if(action == 'edit'){
                var url = "${ctx}/xtgl/zzgl/yhgl/editPage?flag=edit&username=" + data.username;
                var index = layer.open({
                    title:action,
                    type: 2,
                    fixed: false, //不固定
                    maxmin: true,
                    content: url,
                    end: function(){
                        table.reload(tableId)
                    }
                });
                layer.full(index);
            }else{
                //重置密码
                layer.confirm('确定重置密码为123456吗?', function (index) {
                    var index;
                    $.ajax({
                        type: "post",
                        data: {u_id: data.u_id,username:data.username},
                        url: "${ctx}/xtgl/zzgl/yhgl/resetPassword",
                        beforeSend: function () {
                            index = layer.load(1);
                        },
                        success: function (data) {
                            layer.close(index);
                            if (data > 0) {
                                layer.msg("重置成功", {offset: ['50%'], time: 1000}, function () {
                                    table.reload(tableId)
                                });
                            } else {
                                layer.msg("操作失败")
                            }
                        },
                        error: function (data) {
                            layer.msg("服务端异常");
                        }
                    });
                })
            }
        });

        form.on('submit(query)', function (data) {
            table.reload(tableId, {
                where: data.field
            });
            return false;
        });

        form.on('switch(switchstatus)', function(obj){
            var selectIfKey=obj.othis;
            var parentTr = selectIfKey.parents("tr");
            var dataField = $(parentTr).find("td:eq(1)").find(".layui-table-cell").text();//username
            var status = obj.elem.checked == true? '0':'1';
            var index;
            $.ajax({
                type: "post",
                data: {u_id:dataField,status:status},
                url: '${ctx}/xtgl/zzgl/yhgl/updateUser',
                beforeSend: function () {
                    index = layer.load(1);
                },
                success: function (data) {
                    layer.close(index)
                    var msg = "";
                    if(data > 0){
                        msg = "修改成功";
                    }else{
                        msg = "修改失败";
                    }
                    layer.msg(msg,{offset:['50%'],time: 1000},function(){
                        table.reload(tableId)
                    });
                },
                error: function (data) {
                    layer.close(index)
                    layer.msg("服务器异常",{icon:2});
                }
            });
        })

    });

    function add() {
        var url = "${ctx}/xtgl/zzgl/yhgl/editPage?flag=add";
        var table = layui.table;
        var index = layer.open({
            title: '新增用户',
            type: 2,
            area: ['620px', '400px'],
            fixed: false, //不固定
            maxmin: true,
            content: url,
            end: function () {
                table.reload(tableId)
            }
        });
        layer.full(index);
    }
</script>