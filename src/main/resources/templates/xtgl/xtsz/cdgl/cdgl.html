<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>菜单管理</title>
    <link href="${ctx}/plugins/layui/css/layui.css" rel="stylesheet" />
    <script src="${ctx}/plugins/layui/layui.js"></script>
    <link href="${ctx}/plugins/font-awesome/css/font-awesome.css" rel="stylesheet" />
</head>
<style>
    html,body{
        height: 100%;
    }
    div{
        -moz-box-sizing: border-box;  /*Firefox3.5+*/
        -webkit-box-sizing: border-box; /*Safari3.2+*/
        -o-box-sizing: border-box; /*Opera9.6*/
        -ms-box-sizing: border-box; /*IE8*/
        box-sizing: border-box; /*W3C标准(IE9+，Safari5.1+,Chrome10.0+,Opera10.6+都符合box-sizing的w3c标准语法)*/
    }
    .layui-form-item{
        margin-bottom: 0px
    }
    .layui-table, .layui-table-view {
	    margin: 0px 0;
	}
</style>
<body class="layui-layout-body" style="padding: 10px">
<form class="layui-form">
	<div class="layui-form-item">
	        <div class="layui-inline">
	        	<input class="layui-input" type="text" placeholder="菜单名称" name="title">		
	        </div>
	        <div class="layui-inline">
	        	<button class="layui-btn layui-btn-primary" lay-submit="" lay-filter="query">查询</button>
		 	 	<a class="layui-btn layui-btn-primary" onclick="add();">新增</a>
		 	 	<a class="layui-btn layui-btn-primary" onclick="openAll();">展开/折叠</a>
	        	<button class="layui-btn layui-btn-primary" lay-submit="" lay-filter="updateSort">保存排序</button>
	        </div>
	</div>
</form>
<div style="height:100%">
    <table class="layui-hidden layui-table" id="treeTable" lay-filter="treeTable"></table>
</div>
<script>
    var editObj=null,ptable=null,treeGrid=null,tableId='treeTable',layer=null,form=null;
    layui.config({
        base: '${ctx}/plugins/layui/extend/'
    }).extend({
        treeGrid:'treeGrid'
    }).use(['jquery','treeGrid','layer','form'], function(){
        var $=layui.jquery;
        treeGrid = layui.treeGrid;//很重要
        layer=layui.layer;
        form=layui.form;
        ptable=treeGrid.render({
            id:tableId
            ,elem: '#'+tableId
            ,idField:'id'
            ,url:'${ctx}/xtgl/xtsz/cdgl/getall'
            ,treeId:'id'//树形id字段名称
            ,treeUpId:'parentid'//树形父id字段名称
            ,treeShowName:'title'//以树形式显示的字段
            ,height:'full-60'
            ,isFilter:false
            ,iconOpen:true//是否显示图标【默认显示】
            ,isOpenDefault:true//节点默认是展开还是折叠【默认展开】
            ,method:'get'
            ,cols: [[
                 {field:'title', width:500, title: '菜单名称'}
                ,{field:'url', width:200, title: '菜单链接'}
                ,{field:'sort', width:200, title: '排序',edit:'text'}
                ,{field:'status', width:200, title: '状态',templet:function(d){
                	 var html='';
                	 if(d.status == 0){
                		 html = "隐藏"
                	 }else{
                		 html = "显示"
                	 }
                	 return html
                }}
                ,{title: '操作', align:'center'/*toolbar: '#barDemo'*/
                    ,templet: function(d){
                        var html='';
                        	html +='<button class="layui-btn layui-btn-primary layui-btn-xs" lay-event="edit"><i class="fa fa-pencil"></i></button>';
                        	html +='<button class="layui-btn layui-btn-primary layui-btn-xs" lay-event="del"><i class="fa fa-trash-o"></i></button>';
                        if(d.level != '3'){
                        	html +='<button class="layui-btn layui-btn-primary layui-btn-xs" lay-event="add"><i class="fa fa-plus-square-o"></i></button>';
                        }
                        return html;
                    }
                }
            ]]
            ,parseData:function (res) {//数据加载后回调
                return res;
            }
            ,onClickRow:function (index, o) {
                console.log(index,o,"单击！");
            }
            ,onDblClickRow:function (index, o) {
                console.log(index,o,"双击");
            }
        });
        //点击行事件
        treeGrid.on('tool('+tableId+')',function (obj) {
        	var data = obj.data;
        	var action = obj.event;
        	if(action == 'del'){
        		var index;
        		$.ajax({
    			    type: "post",
    			    data: {id:data.id},
    			    url: "${ctx}/menus/del",
    			    beforeSend: function () {
    			    	index = layer.load(1);
    			    },
    			    success: function (data) {
    			    	layer.close(index);
    			    	if(data > 0){
    			    		layer.msg("删除成功",{offset:['50%'],time: 1000},function(){
    			    			 treeGrid.reload(tableId)
    	                    });
    			    	}else{
    			    		layer.msg("操作失败")
    			    	}
    			    },
    			    error: function (data) {
    			    	layer.msg("服务端异常");
    			    }
    		 	});
        	}else{
        		var url = "${ctx}/xtgl/xtsz/cdgl/edit?m_id="+data.id+"&action="+action;
            	if(action == 'edit'){
            		action = "修改";
            	}else{
            		action = "新增";
            	}
               	var index = layer.open({
               		title:action,
               		  type: 2,
               		  area: ['620px', '400px'],
               		  fixed: false, //不固定
               		  maxmin: true,
               		  content: url,
               		  end: function(){
               			  treeGrid.reload(tableId)
               		  }
                });
               	layer.full(index);
        	}
        });
        
        form.on('submit(query)', function(data){
        	treeGrid.reload(tableId,{
        		where:data.field
            });
            return false;
        });
        
        form.on('submit(updateSort)', function(data){
            var map=treeGrid.getDataMap(tableId);
            var array = [];
            for(var item in map){
     	        var json = {};
             	json.id = item;
             	json.sort = map[item].sort
             	array.push(json)
            }
            var index;
            $.ajax({
    		    type: "post",
    		    data: {ids:JSON.stringify(array)},
    		    url: '${ctx}/xtgl/xtsz/cdgl/updateSort',
    		    beforeSend: function () {
    		    	index = layer.load(1);
    		    },
    		    success: function (data) {
    		    	layer.close(index)
    		    	var msg = "";
    		    	if(data > 0){
    		    		msg = "修改成功";
    		    	}else{
    		    		msg = "修改失败";
    		    	}
    		    	layer.msg(msg,{offset:['50%'],time: 1000},function(){
    		    		 treeGrid.reload(tableId)
                    });
    		    },
    		    error: function (data) {
    		    	layer.close(index)
    		    	layer.msg("服务器异常",{icon:2});
    		    }
    		});
            return false;
        });

    });
    
    function add() {
    	var url = "${ctx}/xtgl/xtsz/cdgl/edit?flag=add";
    	var index = layer.open({
       		  title:'新增一级菜单',
       		  type: 2,
       		  area: ['620px', '400px'],
       		  fixed: false, //不固定
       		  maxmin: true,
       		  content: url,
       		  end: function(){
       			  treeGrid.reload(tableId)
       		  }
        });
       	layer.full(index);
    }

    
    function openAll() {
        var treedata=treeGrid.getDataTreeList(tableId);
        treeGrid.treeOpenAll(tableId,!treedata[0][treeGrid.config.cols.isOpen]);
    }
</script>
</body>
</html>